#!/bin/bash

GLIBCVER=2.18
QEMU=1.6.1
ANTVER=1.8.4

AUTOCONF=2.69
AUTOMAKE=1.9.6

NARCH=$( uname -m )

if [ "${1}" ];then
  DARCH=${1}
 else
  DARCH=${NARCH}
fi;

if [ ! "${DARCH}" ] || [ ! -d /dist/pkg/build/${DARCH} ];then
  echo require arch
  exit;
fi;

case ${DARCH} in
	arm*)STRIP=arm-linux-gnueabihf-strip;;
	arm64)STRIP=aarch64-linux-gnu-strip;;
	mips64)STRIP=mips64-linux-gnuabi64-strip;;
	x86_32)STRIP=x86_64-linux-gnux32-strip;;
	*)STRIP=${DARCH}-linux-gnu-strip;;
esac;

if [ ${2} ];then
  STATICROOT=${2}
 else
  STATICROOT=/dist/root/${DARCH}-static
fi;

if [ -d ${STATICROOT} ];then
  rm -rf ${STATICROOT}
fi;
mkdir -p ${STATICROOT}

cd /dist/pkg/build/${DARCH}
for pkg in `ls -d *static *boot` ;do
  for subpkg in `ls ${pkg}/${pkg}.tar.xz ${pkg}/${pkg}-libs.tar.xz ${pkg}/${pkg}-dev.tar.xz 2>/dev/null`;do
    tar -C ${STATICROOT} -xJf ${subpkg};
  done;
done

if [ -e /dist/cross/${NARCH}/qemu-${QEMU}/usr/bin/qemu-${DARCH}-static ];then
  cp /dist/cross/${NARCH}/qemu-${QEMU}/usr/bin/qemu-${DARCH}-static ${STATICROOT}/usr/bin
fi;

#Strip all the bits
${STRIP} ${STATICROOT}/bin/* ${STATICROOT}/sbin/* ${STATICROOT}/usr/bin/* ${STATICROOT}/usr/sbin/*

for devpkg in glibc-${GLIBCVER}/glibc-${GLIBCVER}-headers.tar.xz \
              glibc-${GLIBCVER}/glibc-${GLIBCVER}-static.tar.xz \
              glibc-${GLIBCVER}/glibc-${GLIBCVER}-libs.tar.xz \
              /dist/pkg/${DARCH}/apache-ant-${ANTVER}/apache-ant-${ANTVER}-libs.tar.xz \
              /dist/pkg/${DARCH}/autoconf-${AUTOCONF}/autoconf-${AUTOCONF}.tar.xz \
              /dist/pkg/${DARCH}/automake-${AUTOMAKE}/automake-${AUTOMAKE}.tar.xz \
              kernel-headers.tar.xz /dist/pkg/java-jar.tar.xz;do
  if [ -f ${devpkg} ];then
    tar -C ${STATICROOT} -xJf ${devpkg};
  fi;
done;

for sysdir in proc sys dev root tmp usr/src dist etc/xml;do
  mkdir -p ${STATICROOT}/${sysdir}
done;

cp /etc/passwd /etc/group /etc/hosts ${STATICROOT}/etc
if [ -x /usr/bin/xmlcatalog ];then
  xmlcatalog --noout --create ${STATICROOT}/etc/xml/docbook.xml
  xmlcatalog --noout --create ${STATICROOT}/etc/xml/docbook-xsl.xml
  xmlcatalog --noout --create ${STATICROOT}/etc/xml/catalog.xml
  xmlcatalog --noout --add nextCatalog "file:///etc/xml/docbook.xml" "" ${STATICROOT}/etc/xml/catalog.xml
  xmlcatalog --noout --add nextCatalog "file:///etc/xml/docbook-xsl.xml" "" ${STATICROOT}/etc/xml/catalog.xml
  ln -s catalog.xml ${STATICROOT}/etc/xml/catalog
fi;

for mdir in 1 2 3 4 5 6 7 8;do
  mkdir -p ${STATICROOT}/usr/share/man/man${mdir}
done;

#Install terminfo DB / Stub files / CPAN config
if [ -d /usr/share/terminfo ];then
  rsync -avRP /usr/share/terminfo /usr/include/gnu/stubs-* /root/.cpan/CPAN/MyConfig.pm ${STATICROOT}/
fi;

if [ -d /lib/terminfo ];then
  rsync -avRP /lib/terminfo /usr/include/gnu/stubs-* /root/.cpan/CPAN/MyConfig.pm ${STATICROOT}/
fi;

echo "nameserver ::1" > ${STATICROOT}/etc/resolv.conf
if [ -e ${STATICROOT}.sqfs ];then
  rm ${STATICROOT}.sqfs
fi;

cp /dist/scripts/build ${STATICROOT}/usr/sbin/build_system

mksquashfs ${STATICROOT}/* ${STATICROOT}.sqfs -comp xz
