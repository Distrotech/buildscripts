#!/bin/bash

sync_fin() {
  if [ ! -d ${1}/${PREFIX} ];then
    mkdir -p ${1}/${PREFIX}
  fi;
  rsync -avP ${DESTDIR}${PREFIX}/ ${1}/${PREFIX}/
  exit ${2}
}

NARCH=`uname -m`

export PREFIX=/usr/X11R7
if [ "${1}" == "${NARCH}" ] && [ ! -d /build/${1} ];then
  DESTDIR=/
 else
  DESTDIR=/build/${1}/
fi;
export DESTDIR
export DPATH=${DESTDIR}${PREFIX}
export MAKEFLAGS=${MAKE_J}


export LD_LIBRARY_PATH=/usr/${B_LIBDIRS}:/${B_LIBDIRS}:${SYSROOT}/${B_LIBDIRS}:${SYSROOT}/usr/${B_LIBDIRS}:${SYSROOT}/${PREFIX}/${B_LIBDIRS}

if [ "${4}" ];then
  ./util/modular/build.sh -L |grep -vE "(^driver/xf86-video-newport)|(^driver/xf86-video-sis)|(^mesa)" > tobuild
  cat tobuild |awk '{printf "make -C %s distclean\n",$1}' |sh
fi;

if [ "${NARCH}" == "x86_64" ];then
  case ${1} in
    i686|x86_32|x86_64)BUILD=${2};;
  esac;
fi;

#set
#exit -1


if [ ! -d ${DPATH} ];then
  mkdir -p ${DPATH}
fi;

export CC_FOR_BUILD=gcc
export CXX_FOR_BUILD=g++
export CONFFLAGS="--host=${2} --build=${BUILD} --with-sysroot --libdir=${PREFIX}/${B_LIBDIRS} --disable-selective-werror"

export CXXFLAGS_FOR_BUILD="-L/usr/lib"
export CFLAGS_FOR_BUILD=-I.
export LDFLAGS_FOR_BUILD=-L.

./util/modular/build.sh --modfile ./tobuild ${PREFIX} || sync_fin ${3} 1

#LD Config
mkdir -p ${3}/etc/ld.so.conf.d
echo "/usr/X11R7/${B_LIBDIRS}" > ${3}/etc/ld.so.conf.d/xwin.conf
if [ "${1}" == "${NARCH}" ];then
  /sbin/ldconfig
fi;

sync_fin ${3} 0
