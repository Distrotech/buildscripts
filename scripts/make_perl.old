#!/bin/bash

NARCH=$( uname -m )

#${barch} ${HOST} ${DIST_ROOT} ${CLEANOPT}

unset CC CFLAGS LDFLAGS
export CC=${MLHOST}-gcc

if [ -x ./configure ] && [ -e perl.c ];then
  svn status --no-ignore |grep -E "^(\?|I)" |cut -c9- |awk '{print "rm -rf "$0}' |sh
  svn revert --depth=infinity .
fi;

if [ "${NARCH}" == "${1}" ];then
  sh ./configure --prefix=/usr -A append:cc="${MLOPT} -fPIC" --set ld="${CC}" \
               -A append:ld="${MLOPT}" -Dusethreads -Duseshrplib -Duseopcode
 else
  sh ./configure --prefix=/usr --sysroot=${SYSROOT} --set cc="${CC}" -A append:cc="${MLOPT} -fPIC" \
              --set objdump="${MLHOST}-objdump" --set ld="${CC}" -A append:ld="${MLOPT}" -Dusethreads -Duseshrplib -Duseopcode \
              --host=${2} --build=${BUILD} --target=${2} --host-cc=/usr/bin/gcc
fi;

make DESTDIR=${3} all install || make DESTDIR=${3} all install
