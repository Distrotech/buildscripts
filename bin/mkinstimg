#!/bin/bash

BRAND="Distrotech Solutions";
SYSROOT=/var/opt/dtsbuild/sysroot
KSUF="dts";
DTSSRVDIR=/srv/opt/dtsbuild
KERNEL_VER="3.19.8";

Make_Bootetc() {
  cd ${1}

  rm etc/blkid.* > /dev/null 2>&1

  (cat <<EOF
hosts:  	files dns
passwd:		files
shadow:		files
group:		files
EOF
) > etc/nsswitch.conf

  echo "*.*                                       /dev/tty5" > etc/syslog.conf
  echo "telnet          stream  tcp     nowait  root    /usr/sbin/in.telnetd" > etc/inetd.conf

  if [ -e etc/sshd_config ];then
    sed -i -e "s/^\(PasswordAuthentication\).*/\1 yes/" \
           -e "s/^\(UsePAM\).*/\1 no/" etc/sshd_config
  fi;

  if [ -e etc/inittab ];then
    sed -i -e "s/^.*agetty.*//" etc/inittab
    (cat <<EOF
c1:345:respawn:/sbin/agetty -nl /usr/libexec/shell 38400 tty2 linux
c2:345:respawn:/sbin/agetty -nl /usr/libexec/shell 38400 tty3 linux
c3:345:respawn:/sbin/agetty 38400 tty8 linux
c4:345:respawn:/sbin/agetty 38400 tty9 linux
EOF
) >> etc/inittab
  fi;

  if [ -e etc/nscd.conf ];then
    sed -i -e "s/\(suggested-size.*\)20011/\1211/" etc/nscd.conf
  fi;

  if [ -e etc/localtime ];then
    rm etc/localtime
  fi;
  ln -s ../usr/share/zoneinfo/Africa/Johannesburg etc/localtime

  for todel in HOSTNAME openssl/ca.conf ifconf/* mtab* ppp/ip-up;do
    rm etc/${todel} > /dev/null 2>&1
  done
  ln -s /proc/self/mounts etc/mtab

  if [ ! -d etc/ifconf ];then
    mkdir etc/ifconf
  fi;

  for dfile in netsentry-version group passwd;do
    if [ -e etc/distrotech/${dfile}.dist ];then
      cp etc/distrotech/${dfile}.dist etc/${dfile}
    fi;
  done;

  (cat <<_EOF_
root:\$6\$V.R4jtD.\$d/e4hk86v8LwHr4AWUz0wus2g8QBslNfukkqmOX2tGZPo4SBpMLCZdPJc1ByobXm8YCojBfUCPfXLlLGWIZCp/:16569::::::
admin:\$6\$V.R4jtD.\$d/e4hk86v8LwHr4AWUz0wus2g8QBslNfukkqmOX2tGZPo4SBpMLCZdPJc1ByobXm8YCojBfUCPfXLlLGWIZCp/:16569::::::
_EOF_
) > etc/shadow

  (cat <<_EOF_
#!/bin/bash

(flock -w 20 10 || exit
if [ ! -e /dev/gsmmodem ];then
  TST=X
  while [ "${TST}" != "XXXXXXXX" ] && [ ! -e /dev/gsmmodem ];do
    /usr/bin/sleep 5
    TST=${TST}X
  done;
  if [ ! -e /dev/gsmmodem ];then
    exit
  fi;
fi;

/usr/sbin/pppd /dev/gsmmodem connect "/usr/sbin/chat -v -f /etc/ppp/diald.3g" lock maxfail 5 unit 10 logfile /var/log/pppd.log.3g linkname 3g ipparam 3g defaultroute noauth persist nomultilink usepeerdns

flock -u 10
) 10>/var/lock/ppp10.lock &
_EOF_
) > etc/ifconf/pppup.ppp3g
  chmod 755 etc/ifconf/pppup.ppp3g

  if [ ! -d etc/ppp ];then
    mkdir etc/ppp
  fi;
  (cat <<_EOF_
#!/bin/bash

grep -v "nameserver" /etc/resolv.conf > /tmp/resolv.conf

if [ "\${DNS1}" ];then
  echo "nameserver \${DNS1}" >> /tmp/resolv.conf
fi;

if [ "\${DNS2}" ];then
  echo "nameserver \${DNS2}" >> /tmp/resolv.conf
fi;

cp /tmp/resolv.conf /etc/resolv.conf

_EOF_
) > etc/ppp/ip-up
  chmod 755 etc/ppp/ip-up
  touch etc/.install

  rm root/.bash_history > /dev/null 2>&1
}

image_create() {
  qemu-img create ${1} 20G
  parted -s ${1} mklabel msdos
  parted -s ${1} "mkpart primary 1 -1"
  parted -s ${1} set 1 boot on
}

syslinux_cfg() {
  cat <<EOF
DEFAULT vesamenu.c32
TIMEOUT 150
ONTIMEOUT x86_64
PROMPT 0
NOESCAPE 1
MENU TITLE ${BRAND}
MENU BACKGROUND background.jpg

EOF

  for kernbits in x86_64 x86_x32 x86;do
    if [ -e ${1}/boot/${kernbits}/syslinux.cfg ];then
      cat <<EOF
LABEL ${kernbits}
  MENU LABEL Install options for ${kernbits}
  CONFIG /boot/${kernbits}/syslinux.cfg

EOF
    fi;
  done;
}

syslinux_cfg_arch() {
  cat <<EOF
DEFAULT /boot/syslinux/vesamenu.c32
TIMEOUT 50
ONTIMEOUT install
PROMPT 0
NOESCAPE 1
MENU TITLE ${BRAND}
MENU BACKGROUND /boot/syslinux/background.jpg

LABEL install
  MENU LABEL ${BRAND} ${1} (Install)
  KERNEL /boot/${1}/vmlinuz
  INITRD /boot/${1}/initrd.img
  APPEND ro root=/dev/loop0 nomodeset dts_opt=squashfs squashimg=/boot/${1}/root.img quiet
LABEL rescue
  MENU LABEL ${BRAND} ${1} (Rescue)
  KERNEL /boot/${1}/vmlinuz
  INITRD /boot/${1}/initrd.img
  APPEND ro root=/dev/loop0 nomodeset dts_opt=squashfs squashimg=/boot/${1}/root.img S
LABEL build
  MENU LABEL ${BRAND} ${1} (Build)
  KERNEL /boot/${1}/vmlinuz
  INITRD /boot/${1}/initrd.img
  APPEND ro root=/dev/loop0 nomodeset dts_opt=buildroot squashimg=/boot/${1}/root.img buildimg=/boot/${1}/buildroot.img S
LABEL Main Menu
  MENU LABEL Return To Main Menu
  CONFIG /boot/syslinux.cfg
EOF
}

build_squashfs_img() {
  case ${1} in
    x86)ARCH="i686";
      LIBDIR="lib";;
    x86_x32)ARCH="x86_32";
      LIBDIR="libx32";;
    x86_64)ARCH="x86_64";
      LIBDIR="lib64";;
  esac;

  if [ -e /etc/rpm/platform ];then
    rm /etc/rpm/platform
  fi;

  if [ -e /etc/rpm/platform.${ARCH} ];then
    ln -s -r /etc/rpm/platform.${ARCH} /etc/rpm/platform
  fi

  IMGTMPDIR=${4}/tmp-${ARCH}

  if [ ! -d ${IMGTMPDIR}/tmp ];then
    mkdir -p ${IMGTMPDIR}/tmp
  fi;
  /usr/libexec/distrotech/instpkg ${ARCH} ${IMGTMPDIR} ${3}

  ls -d ${IMGTMPDIR}/opt/*/${LIBDIR} |awk -v MNT=${IMGTMPDIR} '{printf "%s\n",substr($1,length(MNT)+1)}' > ${IMGTMPDIR}/etc/ld.so.conf.d/opt-${3}.conf

  chroot ${IMGTMPDIR} /sbin/ldconfig > /dev/null 2>&1

  if [ "${3}" == "root" ];then
    if [ -x ${SYSROOT}/${ARCH}/sbin/modprobe.static ];then
      rsync -a ${SYSROOT}/${ARCH}/sbin/modprobe.static ${IMGTMPDIR}/sbin/
    fi;
    (Make_Bootetc ${IMGTMPDIR})
  fi;

  yum -y --installroot=${IMGTMPDIR} clean all

  mksquashfs ${IMGTMPDIR}/* ${2}/${3}.img -comp xz

  if [ -e /etc/rpm/platform ];then
    rm /etc/rpm/platform
  fi;

  rm -rf ${IMGTMPDIR}
}

add_kernel() {
  IMGDIR=$(mktemp -d -p /root tmpimgdir.XXXXXXXXXXX)
  if [ ! "${IMGDIR}" ] || [ ! -d ${IMGDIR} ];then
    return 1
  fi;

  for kernbits in x86 x86_64 x86_x32;do
    case ${kernbits} in
      x86)ARCH="i686";;
      x86_x32)ARCH="x86_32";;
      *)ARCH=${kernbits};;
    esac;

    if [ -e ${SYSROOT}/${ARCH}/boot/vmlinuz-${2}-${kernbits}-${KSUF} ];then
      if [ ! -d ${1}/boot/${kernbits} ];then
        mkdir -p ${1}/boot/${kernbits}
      fi;
      cp ${SYSROOT}/${ARCH}/boot/vmlinuz-${2}-${kernbits}-${KSUF} ${1}/boot/${kernbits}/vmlinuz
      mkinitrd bootimg ${1}/boot/${kernbits}/initrd.img ${SYSROOT}/${ARCH}/  ${2}-${kernbits}-${KSUF}
      if [ ! -e  ${1}/boot/${kernbits}/root.img ];then
        build_squashfs_img ${kernbits} ${1}/boot/${kernbits} root ${IMGDIR}
      fi;
      if [ ! -e  ${1}/boot/${kernbits}/buildroot.img ];then
        build_squashfs_img ${kernbits} ${1}/boot/${kernbits} buildroot ${IMGDIR}
      fi;
      syslinux_cfg_arch ${kernbits} > ${1}/boot/${kernbits}/syslinux.cfg
      if [ -d ${DTSSRVDIR}/yum/${ARCH} ];then
        rsync --modify-window=1 --exclude="${ARCH}/*/*/*-dbg-*.${ARCH}.rpm" --delete -a ${DTSSRVDIR}/yum/${ARCH} ${1}/repo
      fi;
    fi;
  done;
  rm -rf ${IMGDIR}
}

config_installer() {
  if [ ! -d ${1}/boot/syslinux ];then
    mkdir -p ${1}/boot/syslinux
  fi;

  for slinfile in vesamenu.c32 libcom32.c32 libutil.c32;do
    if [ -e /usr/share/syslinux/${slinfile} ];then
      cp /usr/share/syslinux/${slinfile} ${1}/boot/syslinux
    fi;
  done
#  cp /usr/share/syslinux/*.{c32,com,exe} ${1}/boot/syslinux

  add_kernel ${1} ${2}
  syslinux_cfg ${1} > ${1}/boot/syslinux/syslinux.cfg

  YUM_GRP_FILE=$(ls -t ${DTSSRVDIR}/yum/repodata/*-groups.xml |head -1)
  if [ ! -d ${1}/repo/repodata ];then
    mkdir -p ${1}/repo/repodata
    cp ${YUM_GRP_FILE} ${1}/repo/repodata/groups.xml
    createrepo -g repodata/groups.xml ${1}/repo
   else
    cp ${YUM_GRP_FILE} ${1}/repo/repodata/groups.xml
    createrepo -g repodata/groups.xml --skip-stat --update ${1}/repo
  fi;

  if [ -e /boot/grub/background.jpg ];then
    cp /boot/grub/background.jpg ${1}/boot/syslinux/
  fi;
}

build_installer() {
  if [ ! -b ${1} ] && [ ! -e ${1} ];then
    image_create ${1}
    FLOOP=$(losetup -f)
    if [ ! "${FLOOP}" ];then
      exit 1;
    fi;
    losetup ${FLOOP} ${1}
    INSTDEV=${FLOOP}p1
    mkdosfs -F 32 -n DTS_INSTALL ${INSTDEV}
   elif [ -b ${1} ];then
    INSTDEV=${1}1
   elif [ -e ${1} ];then
    FLOOP=$(losetup -f)
    if [ ! "${FLOOP}" ];then
      exit 1;
    fi;
    losetup ${FLOOP} ${1}
    INSTDEV=${FLOOP}p1
   else
    exit 1
  fi;

  dosfsck -a ${INSTDEV} >/dev/null 2>&1

  mount ${INSTDEV} ${3}

  config_installer ${3} ${2}

  umount ${3}

  syslinux -f -i -d boot/syslinux ${INSTDEV}
  dd if=/usr/share/syslinux/mbr.bin of=${1} conv=notrunc bs=512b count=1

  if [ ! -b ${1} ];then
    losetup -d ${FLOOP}
  fi;
}


TMPDIR=$(mktemp -d -p /tmp mkinstmnt.XXXXXXXXXXX)
if [ ! "${TMPDIR}" ] || [ ! -d ${TMPDIR} ];then
  exit 1
fi;

if [ "${1}" ];then
  INST_DEV="${1}"
 else
  INST_DEV="dts-install";
fi;

build_installer ${INST_DEV} ${KERNEL_VER} ${TMPDIR}

rm -rf ${TMPDIR}
