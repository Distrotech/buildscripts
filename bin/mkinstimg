#!/bin/bash

BRAND="Distrotech Solutions";
KSUF="dts";

image_create() {
  qemu-img create ${1} 16G
  parted -s ${1} mklabel msdos
  parted -s ${1} "mkpart primary 1 -1"
  parted ${1} set 1 boot on
}

syslinux_cfg() {
  cat <<EOF
DEFAULT vesamenu.c32
TIMEOUT 5000
ONTIMEOUT install-x86_64
PROMPT 0
NOESCAPE 1
MENU TITLE ${BRAND}
MENU BACKGROUND background.jpg

EOF

  for kernbits in x86 x86_64;do
    if [ -d ${1}/boot/${kernbits} ];then
      cat <<EOF
LABEL install-${kernbits}
  MENU LABEL ${BRAND} ${kernbits} (Install)
  KERNEL /boot/${kernbits}/vmlinuz
  APPEND ro root=/dev/loop0 initrd=/boot/${kernbits}/initrd.img dts_opt=squashfs quiet
LABEL rescue-${kernbits}
  MENU LABEL ${BRAND} ${kernbits} (Rescue)
  KERNEL /boot/${kernbits}/vmlinuz
  APPEND ro root=/dev/loop0 initrd=/boot/${kernbits}/initrd.img dts_opt=squashfs S
EOF
    fi;
  done;
}

add_kernel() {
  for kernbits in x86 x86_64;do
    if [ -e /boot/vmlinuz-${2}-${kernbits}-${KSUF} ];then
      if [ ! -d ${1}/boot/${kernbits} ];then
        mkdir -p ${1}/boot/${kernbits}
      fi;
      cp /boot/vmlinuz-${2}-${kernbits}-${KSUF} ${1}/boot/${kernbits}/vmlinuz
    fi;
  done;
}

config_installer() {
  if [ ! -d ${1}/syslinux ];then
    mkdir ${1}/syslinux
  fi;

  for slinfile in syslinux64.exe syslinux.com syslinux.exe vesamenu.c32 libcom32.c32 libutil.c32;do
    if [ -e /usr/share/syslinux/${slinfile} ];then
      cp /usr/share/syslinux/${slinfile} ${1}/syslinux
    fi;
  done

  add_kernel ${1} ${2}
  syslinux_cfg ${1} > ${1}/syslinux/syslinux.cfg

  if [ -e /boot/grub/background.jpg ];then
    cp /boot/grub/background.jpg ${1}/syslinux/
  fi;
}

build_installer() {
  if [ ! -b ${1} ] && [ ! -e ${1} ];then
    image_create ${1}
    FLOOP=$(losetup -f)
    if [ ! "${FLOOP}" ];then
      exit 1;
    fi;
    losetup ${FLOOP} ${1}
    INSTDEV=${FLOOP}p1
    mkdosfs -F 32 -n DTS_INSTALL ${INSTDEV}
   elif [ -b ${1} ];then
    INSTDEV=${1}1
   elif [ -e ${1} ];then
    FLOOP=$(losetup -f)
    if [ ! "${FLOOP}" ];then
      exit 1;
    fi;
    losetup ${FLOOP} ${1}
    INSTDEV=${FLOOP}p1
   else
    exit 1
  fi;

  mount ${INSTDEV} ${3}

  config_installer ${3} ${2}
  syslinux -i -d syslinux ${INSTDEV}

  umount ${3}
  dd if=/usr/share/syslinux/mbr.bin of=${1} conv=notrunc

  if [ ! -b ${1} ];then
    losetup -d ${FLOOP}
  fi;
}


TMPDIR=$(mktemp -d)
if [ ! "${TMPDIR}" ] || [ ! -d ${TMPDIR} ];then
  exit 1
fi;

build_installer dts-install 3.14.4 ${TMPDIR}

rm -rf ${TMPDIR}
