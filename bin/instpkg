#!/bin/bash
barch=x86_64;
pkgdir=/dist/pkg

MNTDIR=$(mktemp -d install-XXXXXXXX)

update_pkg(){

  time tar -C /root/newinstall -xf ${1}
  echo ${1}

#  archivemount ${1} ${MNTDIR}
#  umount ${MNTDIR}
}


for pkg in `ls /dist/def/`;do
  (eval `cat /dist/def/${pkg}`
    AVER=VERSION_${barch}
    if [ "${!AVER}" ];then 
      VERSION=${!AVER}
    fi;
    eval ${AVER}=""

    DONTBUILDPAT=${DONTBUILD// /|}
    if [ "${DONTBUILD}" ] && [[ ${barch} =~ ${DONTBUILDPAT} ]];then
      continue;
    fi;

    cpkg=${pkg}${VERSEP}${VERSION}

    for ptar in `ls ${pkgdir}/${barch}/${cpkg}/`;do
      case ${ptar} in
        ${cpkg}.tar.xz|*-doc.tar.xz|*-libs.tar.xz|*-locale.tar.xz|*-jre.tar.xz)update_pkg ${pkgdir}/${barch}/${cpkg}/${ptar};;
        *-conf.tar.xz)true;;
        *-dbg.tar.xz|*-dev.tar.xz|*-jdk.tar.xz)true;;
        *)echo ${ptar}
      esac;
    done
#    dev|dbg|libs|locale|doc|static|boot|shared|headers|jdk|jre
#    rsync -avP /dist/build/${barch}/${pkg}${VERSEP}${VERSION}/ /build/${barch}/
  )
done


if [ -d ${MNTDIR} ];then
  rm -rf ${MNTDIR}
fi;
