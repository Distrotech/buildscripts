#!/bin/bash

DISTDIR=/dist
PKGDISTDIR=${DISTDIR}/pkg
CROSSDISTDIR=${DISTDIR}/cross
DEFDIR=${DISTDIR}/def
ARCHROOT=/build

NARCH=$( uname -m )

case ${NARCH} in
  arm*)NARCH=arm;;
  ppc)NARCH=powerpc;;
  ppc64)NARCH=powerpc64;;
esac;

build_toolchain_dir() {
  case ${1} in
    x86_*|i[3-6]86)LINARCH="x86";;
    arm64)LINARCH=arm64;;
    *64)LINARCH=${1::-2};;
    *)LINARCH=${1};
  esac;

  if [ -e ${PKGDISTDIR}/build/${1}kernel-headers.tar.xz ];then
    tar --exclude=*/.dbg/* -C ${2} -xJf ${PKGDISTDIR}/build/${1}kernel-headers.tar.xz;
  fi;

  if [ ! -e ${2}/usr/include/asm ];then
    ln -s asm-${LINARCH} ${2}/usr/include/asm
  fi;
}

DARCH=${1}
DARCH=${DARCH:=$NARCH}

if [ ${2} ];then
  STATICROOT=${2}
 else
  STATICROOT=${DISTDIR}/root/${DARCH}-buildroot
fi;
build_toolchain_dir ${DARCH} ${STATICROOT}

echo $?

exit

echo "nameserver ::1" > ${STATICROOT}/etc/resolv.conf
if [ -e ${STATICROOT}.sqfs ];then
  rm ${STATICROOT}.sqfs
fi;

mkdir -p ${STATICROOT}${ARCHROOT}/${DARCH}

chroot ${STATICROOT} /sbin/ldconfig
mksquashfs ${STATICROOT}/* ${STATICROOT}.sqfs -comp xz

rm -rf ${STATICROOT}${ARCHROOT}/${DARCH}
ln -f -r -s ${STATICROOT} ${STATICROOT}${ARCHROOT}/${DARCH}
