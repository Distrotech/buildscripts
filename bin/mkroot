#!/bin/bash

NARCH=${NARCH:=$(uname -m)}

if [ ! "${1}" ];then
  echo needs arch
  exit
 else
  ARCH=${1}
fi;

PKG_LIST="bash coreutils util-linux Python perl perl-modules yum rpm LVM2 e2fsprogs openssh dialog \
          gawk sed grep which net-tools iproute2  procps psmisc inetutils xz gzip bzip2 tar less \
          openldap curl nano file screen libxml2 libxslt findutils lynx joe apg avahi bc hdparm htop \
          rp-pppoe rsync iptables ipv6calc kbd lsof macmask modemtest module-init-tools squashfs \
          sysfsutils  dosfstools ethtool nmap nss-mdns ntfs-3g nfs-utils ntp usbutils uudeview \
          unzip openvpn zip p7zip parted pciutils vlan wget gptfdisk ppp kmod dovecot bind \
          systemd samba net-snmp ncurses ncursesw iana-etc tzdata mc glibc bindfs fuse ecryptfs-utils \
          nss_ldap pam_ldap cyrus-sasl libtool-chroot";

case ${ARCH} in
  i[3-6]86|x86_32|x86_64)MARCH=".${ARCH}";;
  *)MARCH=".${ARCH}";;
esac;


RPM_PKG_LIST="";
#while read line;do echo $line;done < pkglist/root.pkglist
for pkg in ${PKG_LIST};do
 RPM_PKG_LIST+=" ${pkg}${MARCH}"
 if [ "`ls /srv/opt/dtsbuild/tar/${ARCH}/${pkg}*/${pkg}*-conf.tar.xz 2>/dev/null`" ];then
   RPM_PKG_LIST+=" ${pkg}-conf${MARCH}"
 fi;
 if [ ! -e /var/opt/dtsbuild/build/status/${ARCH}/done/${pkg} ];then
   echo ${pkg}
 fi
done;

TMPDIR=$( mktemp -d -p /root dtsinstall.XXXXXXXXXXX)

case ${NARCH} in
  x86_32|x86_64|i[3-6]86)
    case ${ARCH} in
      x86_64)yum -y --installroot=${TMPDIR} --exclude="*.x86_32" --exclude="*.i686" install${RPM_PKG_LIST};;
      x86_32)yum -y --installroot=${TMPDIR} --exclude="*.x86_64" --exclude="*.i686" install${RPM_PKG_LIST};;
      i[3-6]86)yum -y --installroot=${TMPDIR} --exclude="*.x86_64" --exclude="*.x86_32" install${RPM_PKG_LIST};;
      *)echo yum -y --installroot=${TMPDIR} --exclude="*.x86_64" --exclude="*.x86_32" --exclude="*.i686" install${RPM_PKG_LIST};;
    esac;;
  *)if [ "${NARCH}" == "${ARCH}" ];then
      yum -y --installroot=${TMPDIR} install${RPM_PKG_LIST};
     else
      yum -y --installroot=${TMPDIR} --exclude="*.${NARCH}" install${RPM_PKG_LIST};
    fi;;
esac;
exit
for dir in root proc sys dev tmp;do
  mkdir ${TMPDIR}/${dir}
done

chroot ${TMPDIR} /sbin/ldconfig

if [ -e install-${ARCH}.squashfs ];then
  rm install-${ARCH}.squashfs
fi;
mksquashfs ${TMPDIR}/* install-${ARCH}.squashfs -comp xz

if [ "${TMPDIR}" ] && [ -d ${TMPDIR} ];then
  rm -rf ${TMPDIR}
fi;
