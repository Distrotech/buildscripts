#!/bin/bash

SYSMNT=${1}

GITPATH=${GITPATH:=/var/spool/git}

NARCH=${NARCH:=$( uname -m )}
case ${NARCH} in
  powerpc)NARCH=ppc;;
  powerpc64)NARCH=ppc64;;
  arm64|aarch64)NARCH=arm64;;
  armv5|armv6)NARCH=${NARCH};;
  arm*)NARCH=arm;;
esac;

case ${SYSARCH} in
  armv6)export QEMU_CPU="arm1176";;
  armv5)export QEMU_CPU="arm926";;
esac;

SYSARCH=${SYSARCH:=${NARCH}}

DTSSRVDIR=@SRVDIR@
ARCHROOT=@ARCHROOT@
SCRIPTDIR=@bindir@
DTSETCDIR=@sysconfdir@
SKELDIR=${DTSETCDIR}/skel

MNTPNT=${SYSMNT:=/mnt}
IMGROOT=${MNTPNT}/build/${DTSSRVDIR}/install
IMGPTH=${IMGROOT}/${SYSARCH}/images
MNTPTH=${MNTPNT}/aufs
AUFSROOT=${MNTPNT}/aufs/mnt/


AUFS_MNT=":${MNTPNT}/repo=rr"


for img_file in root core buildroot;do
  if [ -f ${IMGPTH}/${img_file}.img ];then
    if [ ! -d ${MNTPTH}/${img_file} ];then
      mkdir -p ${MNTPTH}/${img_file}
    fi
    if [ ! -d ${MNTPTH}/${img_file}/tmp ];then
       /bin/mount -o ro ${IMGPTH}/${img_file}.img ${MNTPTH}/${img_file}
    fi;
    AUFS_MNT=":${MNTPTH}/${img_file}=rr${AUFS_MNT}"
  fi;
  binfmt.sh
done

if [ "${SYSARCH}" != "${NARCH}" ] && [ -f ${IMGROOT}/${NARCH}/images/qemu.img ];then
  if [ ! -d ${MNTPTH}/qemu ];then
    mkdir -p ${MNTPTH}/qemu
  fi
  if [ ! -d ${MNTPTH}/qemu/tmp ];then
     /bin/mount -o ro ${IMGROOT}/${NARCH}/images/qemu.img ${MNTPTH}/qemu
  fi;
  AUFS_MNT=":${MNTPTH}/qemu=rr${AUFS_MNT}"
fi;

AUFS_MNT=":${MNTPNT}/build=rr${AUFS_MNT}"

if [ ! -d ${MNTPNT}/user/${SYSARCH} ];then
  mkdir -p ${MNTPNT}/user/${SYSARCH}
  rsync -aP ${MNTPNT}/build/${SKELDIR}/ ${MNTPNT}/user/${SYSARCH}/
fi;

if [ ! -d ${MNTPNT}/user/${SYSARCH}/etc/yum/repos.d ];then
  mkdir -p ${MNTPNT}/user/${SYSARCH}/etc/yum/repos.d
fi

(cat <<__EOF__
[dtsintel]
name = dtsbuild 0.1
baseurl = file:///${DTSSRVDIR}/yum/intel

[dtsarm]
name = dtsbuild 0.1
baseurl = file:///${DTSSRVDIR}/yum/arm

[dtsppc]
name = dtsbuild 0.1
baseurl = file:///${DTSSRVDIR}/yum/ppc

[dtsmips]
name = dtsbuild 0.1
baseurl = file:///${DTSSRVDIR}/yum/mips
__EOF__
) > ${MNTPNT}/user/${SYSARCH}/etc/yum/repos.d/dtsbuild.repo

/bin/mount -t aufs -o br:${MNTPNT}/user/${SYSARCH}=rw${AUFS_MNT} aufs-root ${AUFSROOT}

for sysmnt in dev proc sys;do
  if [ ! -d ${AUFSROOT}/${sysmnt} ];then
    mkdir ${AUFSROOT}/${sysmnt}
  fi;
done;

if [ ! -d ${AUFSROOT}/dev/pts ];then
  mount -t devtmpfs none ${AUFSROOT}/dev
fi;
if [ ! -d ${AUFSROOT}/dev/pts/ptmx ];then
  mount -t devpts none ${AUFSROOT}/dev/pts
fi;
if [ ! -d ${AUFSROOT}/sys/class ];then
  mount -t sysfs none ${AUFSROOT}/sys
fi;
if [ ! -d ${AUFSROOT}/proc/sys ];then
  mount -t proc none ${AUFSROOT}/proc
fi;

if [ ! -e  ${AUFSROOT}/proc/sys/fs/binfmt_misc/register ];then
  mount -t binfmt_misc none  ${AUFSROOT}/proc/sys/fs/binfmt_misc/
fi;

GITURL=file://${GITPATH} chroot ${AUFSROOT}

if [ -d ${AUFSROOT}/${ARCHROOT} ];then
  for sysroot in `ls ${AUFSROOT}/${ARCHROOT}`;do
     chroot  ${AUFSROOT} ${SCRIPTDIR}/umount-arch ${sysroot} >/dev/null 2>&1
  done
fi;

umount ${AUFSROOT}/dev/pts ${AUFSROOT}/dev ${AUFSROOT}/proc/sys/fs/binfmt_misc ${AUFSROOT}/proc ${AUFSROOT}/sys > /dev/null 2>&1
umount ${AUFSROOT}

for img_file in qemu root core buildroot;do
  if [ -d ${MNTPTH}/${img_file}/tmp ];then
    umount ${MNTPTH}/${img_file}
  fi;
done
